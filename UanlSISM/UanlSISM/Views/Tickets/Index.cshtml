@using Microsoft.AspNet.Identity

@{
    ViewBag.Title = "Tickets - Servicios Médicos";
}

<link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
<link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/magnific-popup.js/1.1.0/magnific-popup.min.css'>
<link rel="stylesheet" href="//code.jquery.com/ui/1.13.1/themes/base/jquery-ui.css">

<style>
    .uanl-logo {
        width: 10vw;
        margin-top: 0vw;
        margin-bottom: 1vw;
    }

    @@font-face {
        font-family: 'Effra-Regular';
        src: url('~/fonts/Effra-Regular.eot');
        src: url('~/fonts/Effra-Regular.eot?#iefix') format('embedded-opentype'), url('~/fonts/Effra-Regular.ttf') format('truetype');
    }

    @@font-face {
        font-family: 'Effra-Bold';
        src: url('~/fonts/Effra-Bold.eot');
        src: url('~/fonts/Effra-Bold.eot?#iefix') format('embedded-opentype'), url('~/fonts/Effra-Bold.ttf') format('truetype');
    }


    .somos-uni {
        width: 5vw;
        margin-top: 1vw;
        margin-bottom: 3vw;
    }

    .linea-arriba {
        position: absolute;
        top: 0;
        right: 0;
        z-index: -1;
        width: 2.5vw;
        margin-top: 5.8vw;
    }

    .linea-abajo {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 2.5vw;
        margin-bottom: 0.7vw;
    }

    .fc-title {
        color: white;
    }

    .fc-time {
        color: white;
    }

    .fc-day-grid-event:hover .fc-title {
        color: black !important;
    }

    .fc-day-grid-event:hover .fc-time {
        color: black !important;
    }

    #busqueda input {
        padding: 0px 8px 4px 8px;
        border: none;
        border-bottom: 1px solid lightgray;
        border-radius: 0px;
        margin-top: 2px;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        color: #2C3E50;
        font-size: 16px;
        letter-spacing: 1px;
    }

        #busqueda input:focus {
            -moz-box-shadow: none !important;
            -webkit-box-shadow: none !important;
            box-shadow: none !important;
            border: none;
            font-weight: bold;
            border-bottom: 2px solid #FBC43D;
            outline-width: 0
        }

    .btn-buscar {
        background-color: #FBC43D !important;
        color: white !important;
    }

        .btn-buscar:hover {
            background-color: #FBC43D !important;
            color: white !important;
        }

    .btn-guardar {
        background-color: #FBC43D !important;
        color: white !important;
    }

        .btn-guardar:hover {
            background-color: #FBC43D !important;
            color: white !important;
        }

    .btnbuscapac {
        width: 1.5vw;
        -webkit-filter: invert(100%);
        filter: invert(100%);
    }

    .dataTables_length {
        display: none;
    }

    .btn-asignar {
        background-color: #FBC43D !important;
        color: white !important;
        border: 2px solid #FBC43D;
        width: 100%;
    }

        .btn-asignar:hover {
            background-color: #FBC43D !important;
        }

    .foto-paciente {
        width: 6vw;
        height: 6vw;
        border-radius: 6vw;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        background-color: rgba(0,74,143,0.8);
    }

    .form-control {
        max-width: 100%;
        border: none;
        border-radius: 0px;
        border-bottom: 2px solid #FBC43D;
    }

    .btn-asignar-modal {
        background-color: #FBC43D !important;
        border: 2px solid #FBC43D !important;
        color: white !important;
        width: 100%;
        max-width: 100%;
    }

    .modal-content {
        margin-top: 10vw;
    }

    .paginate_button {
        padding: 2px 10px;
        cursor: pointer;
    }

    .paging_simple_numbers .current {
        background-color: #FBC43D !important;
        color: white !important;
        cursor: pointer;
    }

    .previous {
        padding-left: 0px !important;
    }

    .dataTables_paginate {
        margin-top: 10px;
    }

    #example2_filter label {
        width: 100%;
    }

    #example2_filter input {
        width: 85%;
        max-width: 85%;
        margin-left: 10px;
        background-color: transparent;
    }


    .btn-agregar {
        padding: 2px 20px 4px 20px;
        background-color: #FBC43D;
        color: white;
        border-radius: 0px;
        font-size: 2opx;
        margin-bottom: 10px;
        font-weight: bolder;
    }

        .btn-agregar:hover {
            color: white;
        }


    #asignarModal .modal-dialog {
        max-width: 800px;
    }


    .dropzone {
        position: relative;
        background-color: #ededed;
        color: white;
        font: bold 24px/200px arial;
        height: 60px;
        text-align: center;
        width: 60px;
        line-height: 60px;
        border-radius: 100%;
        overflow: hidden;
        margin: auto;
        cursor: pointer;
    }

        .dropzone.hover {
            border: 10px solid #FE5;
            color: #FE5;
        }

        .dropzone.dropped {
            background: #222;
        }

        .dropzone div {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            background-position: center;
            background-repeat: no-repeat;
            background-size: cover;
        }

        .dropzone img {
            border-radius: 10px;
            vertical-align: middle;
            max-width: 40%;
            max-height: 40%;
        }

        .dropzone [type="file"] {
            cursor: pointer;
            position: absolute;
            opacity: 0;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            width: 100%;
            max-width: 100%;
        }
</style>

<style type="text/css" media="screen and (max-width: 991px)">
    .resnone {
        display: none;
    }
</style>


<img class="linea-abajo" src="~/Imagenes/lineas-uanl-izquierda.png">
<img class="linea-arriba" src="~/Imagenes/lineas-uanl-derecha.png">

<div id="loadingDiv" style="display:none;">
    <div class="spinner-border" role="status">
        <span class="sr-only">Loading...</span>
    </div>
</div>


<div class="row m-0">
    <div class="col-md-12" id="menu">
        <table>
            <tr>
                <td><a href="@Url.Action("Index", "Home")"><b>Inicio</b></a></td>
                <td> <span class="material-icons">keyboard_arrow_right</span></td>
                <td><a href="@Url.Action("Medico", "Manage")"><b>Médico</b></a></td>
                <td> <span class="material-icons">keyboard_arrow_right</span></td>
                <td><a href="@Url.Action("Index", "Tickets")"><b>Sistema de Tickets</b></a></td>
            </tr>
        </table>
    </div>

    <div class="col-md-12 text-center m-auto pl-3 pr-3 pt-1 pb-0 inputBarcode" id="msform">
        <img src="~/Imagenes/uanl-logo.png" class="uanl-logo" />
        <h4 class="mt-3 mb-3"><b>Sistema de Tickets</b></h4>
    </div>

    <div class="col-md-4 text-right ml-auto p-0">
        <button class="btn btn-agregar">Agregar</button>
    </div>

    <div class="col-12 p-3">
        <table id="example2" class="table table-bordered table-striped" width="100%">
            <!--caption style="caption-side: top">Selecciona un derechohabiente</caption-->
            <thead>
                <tr>
                    <th></th>
                    <th>ID</th>
                    <th>Descripción</th>
                    <th>Solicita</th>
                    <th>Encargado</th>
                    <th>Estado</th>
                    <th>Fecha</th>
                    <th data-priority="1"></th>
                </tr>
            </thead>
        </table>

    </div>
</div>


<!-- Modal -->
<div class="modal fade" id="agendarModal" tabindex="-1" role="dialog" aria-labelledby="agendarModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-body">
                @using (Html.BeginForm("GuardarTicket", "Tickets", FormMethod.Post))
                {
                    <div class="row m-0">
                        <div class="col-12 p-2 m-auto text-center">
                            <h4><b id="tituloModal">Nuevo Ticket</b></h4>
                        </div>
                        <div class="col-12 p-2">
                            <input type="hidden" name="id" id="idModal" value="0" />
                            <select class="form-control mt-3" name="area" id="area" required>
                                <option value="" selected disabled>Seleccionar área</option>
                            </select>

                            <select class="form-control mt-3" name="tipo" id="tipo" required>
                                <option value="" selected disabled>Seleccionar tipo</option>
                            </select>

                            <textarea class="form-control mt-3" name="descripcion" id="descripcion" placeholder="Descripción" required></textarea>




                            <button type="submit" class="btn btn-guardar mt-4" style="width:100%;">Guardar</button>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>



<!-- Modal -->
<div class="modal fade" id="asignarModal" tabindex="-1" role="dialog" aria-labelledby="asignarModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-body">
                @using (Html.BeginForm("AsignarTicket", "Tickets", FormMethod.Post, new { enctype = "multipart/form-data" }))
                {
                <div class="row m-0">
                    <div class="col-12 p-2 m-auto text-center">
                        <h4><b>Ticket #<span id="idticket"></span> </b> </h4>
                        <input type="hidden" id="id" name="id" />
                    </div>
                    <div class="col-7 p-2">
                        <h6>Usuario: <span id="usuarioticket"></span></h6>
                    </div>
                    <div class="col-5 p-2 text-right">
                        <h6><em>Fecha: <span id="fechaticket"></span> </em></h6>
                    </div>
                    <div class="col-12 p-2">
                        <h6>Descripción:</h6>
                        <span id="descripcionticket"></span>
                    </div>

                    <div class="col-12 p-2 m-auto pt-4 asignar">
                        <h6><b>Asignar</b> </h6>
                        <select class="form-control" id="asignar" name="usuario_encargado" required>
                        </select>

                        <h6 class="mt-3"><b>Fecha estimada</b> </h6>
                        <input class="form-control" name="fecha_estimada" type="text" id="datepicker">


                    </div>


                    <div class="col-12 p-0">
                        <div class="row m-0 pt-4">
                            <div class="col-12 p-2 m-auto">
                                <h6><b>Seguimiento</b> </h6>
                            </div>
                        </div>
                    </div>

                    <div class="col-12 p-0 infoseg">

                    </div>

                    <div class="col-md-1 col-3 p-0 m-auto imagenTicket pt-3">
                        <div class="dropzone">
                            <div><img class="camara" src="~/Imagenes/iconos/camara.png" /></div>
                            <input type="file" name="file" accept="image/png, image/jpeg, image/jpg" />
                        </div>
                    </div>

                    <div class="col-md-11 col-9 p-2 m-auto pt-4 textoTicket">
                        <textarea name="seguimiento" class="form-control" id="seguimiento" placeholder="Descripción"></textarea>
                    </div>

                    <div class="col-12 p-2">
                        <button type="submit" class="btn btn-guardar mt-4" id="btnUsuario" style="width:100%;">Asignar</button>
                    </div>

                    <div class="col-12 p-2 cerrarTicket">
                        <button type="button" class="btn btn-success" id="btnCerrar" style="width:100%;">Cerrar</button>
                    </div>

                    <!--div id="galeria"></div-->

                </div>
                }

            </div>
        </div>
    </div>
</div>




<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>


<script>
    function imgError(image) {
        image.onerror = "";
        image.src = "http://148.234.143.205/SISM/Imagenes/uanl.png";
        return true;
    }
</script>


<script src='https://cdn.datatables.net/v/dt/dt-1.10.15/datatables.min.js'></script>
<script src="~/Scripts/dataTables.select.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.2.6/js/dataTables.responsive.min.js"></script>

<script>
    $(document).ready(function () {

        var table2 = $('#example2').DataTable({
            destroy: true,
            searching: true,
            responsive: true,
            "ajax": {
                "url": "@Url.Action("ListaTickets", "Tickets")",
                "dataSrc": "",
            },
            "language": {
                "search": "Buscar ticket:",
                "zeroRecords": "No se encontró ningun ticket",
                "paginate": {
                    "first": "Primero",
                    "last": "Último",
                    "next": "Siguiente",
                    "previous": "Anterior"
                },
                "select": {
                    "rows": " %d filas seleccionadas"
                },
                "loadingRecords": "Un momento, cargando tickets...",
                "processing": "Procesando tickets...",
                "info": "Mostrando _START_ a _END_ de _TOTAL_ tickets",
                "lengthMenu": "Mostrando _MENU_ tickets",
            },
            "columns": [
                { "data": "color" },
                { "data": "id" },
                { "data": "descripcion" },
                { "data": "usuario" },
                { "data": "encargado" },
                { "data": "estado" },
                { "data": "fecha_registro" },
                { "data": "boton" },
            ],
            "columnDefs": [
                {
                    targets: 0,
                    width: '50',
                },
                {
                    targets: 1,
                    width: '50',
                },
                //{ "visible": false, "targets": 5 },
            ],
            "order": [[1, 'desc']],
        });


        table2.on('click', '.btn-asignar', function () {

            var id = $(this).attr('data-info');
            //alert(info);

            $(".infoseg").empty();
            $("#asignar").empty();
            $('#descripcion').text('');

            $.ajax({
                url: '@Url.Action("DetallesTicket", "Tickets")',
                dataType: "json",
                data: { id: id },
                success: function (data) {
                    //alert(data.opciones);
                    $('#idticket').text(data.id);
                    $('#id').val(data.id);
                    $('#idCerrar').val(data.id);
                    $('#descripcionticket').text(data.descripcion);
                    $('#fechaticket').text(data.fecha);
                    $('#usuarioticket').text(data.usuario_realiza);
                    $("#asignar").append(data.opciones);
                    $(".infoseg").append(data.segui);
                    $('#btnUsuario').text(data.boton_usuario);
                    $('#galeria').append(data.galeria);

                    //alert(data.id_usuario);
                    //alert(data.usuario2);
                    //alert(data.fecha_cierre);

                    if (data.usuario2 == data.usuario) {
                        $('.cerrarTicket').show();
                    } else {
                        if (data.usuario3 == data.id_usuario) {
                            $('.cerrarTicket').show();
                        } else {
                            $('.cerrarTicket').hide();
                        }   
                    }


                    if (data.fecha_cierre) {

                        $('#btnUsuario').hide();
                        $('#btnCerrar').text('Cerrado');
                        $('#btnCerrar').attr('disabled', 'disabled');
                        $('.imagenTicket').hide();
                        $('.textoTicket').hide();

                    } else {

                        $('#btnUsuario').show();
                        $('#btnCerrar').text('Cerrar');
                        $('#btnCerrar').removeAttr('disabled');
                        $('.imagenTicket').show();
                        $('.textoTicket').show();
                    }

                    if(data.boton_cerrar) {
                        $('#btnCerrar');
                    }

                    //alert(data.asignar);

                    if(data.asignar == 1) {
                        $('.asignar').show();
                    } else {
                        $('.asignar').hide();
                    }
                },
                error: function (xhr, status, error) {
                    alert('Ticket ya no existe');
                }
            });



            $('#asignarModal').modal("show");

        });

    });



        $(".btn-agregar").click(function () {

            $('#tituloModal').text('Nuevo Ticket');
            $('#agendarModal').modal("show");

        });
</script>

<script>
    $.ajax({
        url: '@Url.Action("AreasList", "Tickets")',
        dataType: "json",
        success: function (data) {
            $.each(data, function (i, item) {
                $('#area').append('<option value="' + item.id + '">' + item.area + '</option>');
            });
        },
        error: function (xhr, status, error) {

        }
    });
</script>


<script>
    $("#area").change(function () {
        var area = $(this).val();
        $('#tipo').empty();
        $('#tipo').append('<option value="" selected disabled>Seleccionar tipo</option>');

        $.ajax({
            url: '@Url.Action("TiposList", "Tickets")',
            dataType: "json",
            data: { area: area },
            success: function (data) {
                $.each(data, function (i, item) {
                    $('#tipo').append('<option value="' + item.id + '">' + item.tipo + '</option>');
                });
            },
            error: function (xhr, status, error) {

            }
        });
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
<script>
    $("#btnCerrar").click(function () {
        var id = $('#id').val();
        var seguimiento = $('#seguimiento').val();

        //alert(id);
        Swal.fire({
            title: '¿Quieres cerrar este ticket?',
            showDenyButton: false,
            showCancelButton: true,
            confirmButtonText: 'Cerrar',
            cancelButtonText: `Cancelar`,
        }).then((result) => {
            if (result.isConfirmed) {


                $.ajax({
                    url: '@Url.Action("CerrarTicket", "Tickets")',
                    dataType: "json",
                    data: { id: id, seguimiento: seguimiento },
                    success: function (data) {
                        Swal.fire('¡Cerrado con éxito!', '', 'success');
                        window.location.href = "@Url.Action("Index", "Tickets")"
                    },
                    error: function (xhr, status, error) {
                        Swal.fire('Error', '', 'success');
                    }
                });


            }
        });
    });
</script>


<script>
    $(function () {

        $('.dropzone').on('dragover', function () {
            $(this).addClass('hover');
        });

        $('.dropzone').on('dragleave', function () {
            $(this).removeClass('hover');
        });

        $('.dropzone input').on('change', function (e) {
            var file = this.files[0];


            //alert(file);

            $('.imagenTicket').removeClass('col-1');
            $('.imagenTicket').addClass('col-12');
            $('.textoTicket').removeClass('col-11');
            $('.textoTicket').addClass('col-12');

            $('.dropzone').css('height', '300px');
            $('.dropzone').css('width', '100%');
            $('.dropzone').css('line-height', '300px');
            $('.dropzone').css('border-radius', '0px');


            //$('.dropzone').removeClass('hover');
            $(this).parent(".dropzone").removeClass('hover');

            if (this.accept && $.inArray(file.type, this.accept.split(/, ?/)) == -1) {
                return alert('File type not allowed.');
            }

            //$('.dropzone').addClass('dropped');
            $(this).parent(".dropzone").addClass('dropped');
            $(".dropzone").removeClass('active');
            $(this).parent(".dropzone").addClass('active');
            //$(this).children('img').hide();
            //$('.dropped img').remove();
            //$(this).siblings("img").hide();
            //$(this).closest('.dropzone').find('img').hide();

            if ((/^image\/(jpg|png|jpeg)$/i).test(file.type)) {
                var reader = new FileReader(file);

                //alert(file);

                reader.readAsDataURL(file);

                reader.onload = function (e) {
                    var data = e.target.result;
                    //$img = $('<img style="width:100%; overflow:hidden;" />').attr('src', data).fadeIn();

                    $('.active div').css('background-image', 'url(' + data + ')');
                    //alert($img);
                    //$(this).siblings("div").html($img);
                };
            } else {
                var ext = file.name.split('.').pop();

                $('.active div').html(ext);
                //$(this).siblings("div").html(ext);
            }
        });
    });
</script>


@if (TempData["message_success"] != null)
{
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
    <script>
        Swal.fire({
            icon: 'success',
            title: '@TempData["message_success"]',
        });
    </script>
}

@if (TempData["message_warning"] != null)
{
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
    <script>
        Swal.fire({
            icon: 'warning',
            title: '@TempData["message_warning"]',
        });
    </script>
}

<script src='https://cdnjs.cloudflare.com/ajax/libs/magnific-popup.js/1.1.0/jquery.magnific-popup.min.js'></script>

<script>
    $(document).ready(function () {

        $('a.btn-gallery').on('click', function (event) {
            event.preventDefault();

            var gallery = $(this).attr('href');

            $(gallery).magnificPopup({
                delegate: 'a',
                type: 'image',
                gallery: {
                    enabled: true
                }
            }).magnificPopup('open');
        });

    });
</script>

<script src="https://code.jquery.com/ui/1.13.1/jquery-ui.js"></script>
<script>
    $(function () {

        $("#datepicker").datepicker({
            //dateFormat: "mm-dd-yy",
            dateFormat: "yy-mm-dd",
            //altField: "#altField"
        });


    });
</script>

