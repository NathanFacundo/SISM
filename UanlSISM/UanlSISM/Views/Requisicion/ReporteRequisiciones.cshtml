
@{
    ViewData["Title"] = "Reporte Requisiciones";
}

@*DATATABLES*@
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script type="text/javascript" src="~/Scripts/2023/jquery.min.js"></script>

<link rel="stylesheet" href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.min.css" />
<link rel=¨stylesheet¨ href="~/Scripts/2023/jquery.dataTables.min.css">

<script src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="~/Scripts/2023/jquery.dataTables.min.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css">
<link rel=¨stylesheet¨ href="~/Scripts/2023/bootstrap-icons.css">

@*CSS only*@
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
<link rel=¨stylesheet¨ href="~/Scripts/2023/bootstrap.min.css">

@*JavaScript Bundle with Popper*@
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js" integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf" crossorigin="anonymous"></script>
<script type="text/javascript" src="~/Scripts/2023/bootstrap.bundle.min.js"></script>

<script src="~/JavaScript/jquery.tablesorter.js" type="text/javascript"></script>

@*SWAL FIRE*@
<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script type="text/javascript" src="~/Scripts/2023/sweetalert2@11.js"></script>

<row class="row m-0">
    <div class="col-md-12" id="menu">
        <table>
            <tr>
                <td><a href="@Url.Action("Index", "Home")"><b>Inicio</b></a></td>
                <td> <span class="material-icons">keyboard_arrow_right</span></td>
                <td><a href="@Url.Action("Medico", "Manage")"><b>Médico</b></a></td>
                <td> <span class="material-icons">keyboard_arrow_right</span></td>
            </tr>
        </table>
    </div>
</row>

<style>
    table.dataTable {
        width: 100% !important;
    }

    .btn-space {
        margin-right: 5px;
    }
</style>

<div>
    <div class="row align-items-end mb-4">
        <div class="col-12 mb-3">
            <h5 class="text-center m-0" style="color: blue; font-weight: bold; font-family: Roboto, Helvetica, Arial, sans-serif;">
                @ViewData["Title"]
            </h5>
        </div>
        <div class="col-md-3 mb-2">
            <label for="inicio">Inicio</label>
            <input type="date" id="datepickerInicio" date-format="DD/MM/YYYY" class="form-control">
        </div>
        <div class="col-md-3 mb-2">
            <label for="fin">Fin</label>
            <input type="date" id="datepickerFin" date-format="DD/MM/YYYY" class="form-control">
        </div>
        <div class="col-md-2 mb-2">
            <label>
                <input type="checkbox" id="cb1" name=""> Requisiciones Almacén.
            </label>
            <br />
            <label>
                <input type="checkbox" id="cb2" name=""> Requisiciones Farmacia.
            </label>
        </div>
        <div class="col-md-2 mb-2">
            <button type="button" class="btn btn-primary w-100" style="background-color: #0431B4; color:yellow;" onclick="Buscar()">Buscar</button>
        </div>
        <div class="col-md-2 mb-2">
            <button type="button" class="btn btn-outline-primary w-100" onclick="Limpiar()">Limpiar Filtros</button>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <table class="table table-striped table-hover" id="TblReporteReq">
                <thead>
                    <tr>
                        <th class='text-center'>Folio<br /> Req.</th>
                        <th class='text-center'>Fecha<br /> Req.</th>
                        <th class='text-center'>Estatus<br /> Compra.</th>
                        <th class='text-center'>Contrato<br /> Req.</th>
                        <th class='text-center'>Usuario Elabora<br /> Req.</th>
                        <th class='text-center'>Tipo<br /> Req.</th>
                        <th class='text-center'>Cant. Solicitada<br /> Req.</th>
                        <th class='text-center'>Cant. Pendiente<br /> Compra.</th>
                        <th class='text-center'>Clave<br /> Med.</th>
                        <th class='text-center'>Descripción<br /> Med.</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.1/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.11.2/moment.min.js"></script>
<script src="//cdn.datatables.net/1.10.12/js/jquery.dataTables.min.js"></script>
<script src="//cdn.datatables.net/plug-ins/1.10.12/sorting/datetime-moment.js"></script>

<script src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="~/Scripts/2023/jquery.dataTables.min.js"></script>

<script src="https://cdn.datatables.net/buttons/2.2.3/js/dataTables.buttons.min.js"></script>
<script type="text/javascript" src="~/Scripts/2023/dataTables.buttons.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script type="text/javascript" src="~/Scripts/2023/jszip.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script type="text/javascript" src="~/Scripts/2023/pdfmake.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script type="text/javascript" src="~/Scripts/2023/vfs_fonts.js"></script>

<script src="https://cdn.datatables.net/buttons/2.2.3/js/buttons.html5.min.js"></script>
<script type="text/javascript" src="~/Scripts/2023/buttons.html5.min.js"></script>

<script src="https://cdn.datatables.net/buttons/2.2.3/js/buttons.print.min.js"></script>
<script type="text/javascript" src="~/Scripts/2023/buttons.print.min.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
<link rel=¨stylesheet¨ href="~/Scripts/2023/bootstrap-datepicker.min.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
<script type="text/javascript" src="~/Scripts/2023/bootstrap-datepicker.min.js"></script>

<script src="https://cdn.datatables.net/plug-ins/1.10.21/dataRender/datetime.js" charset="utf8"></script>

<script>

    $(document).ready(function () {

        $('#TblReporteReq').DataTable({
            paging: false,
            scroller: false,
            responsive: true,
            searching: false,
            info: true,
            lengthChange: false,
            language: {
                "zeroRecords": " ",
                "search": "",
                "info": "",
                "infoEmpty": "",
                "paginate": {
                    "first": "Primero",
                    "last": "Último",
                    "next": "Siguiente",
                    "previous": "Anterior",
                },
                "select": {
                    "rows": " %d filas seleccionadas"
                },
            }
        });

    });

    function formatFecha(fecha) {
        var partes = fecha.split('-');
        return partes[2] + '/' + partes[1] + '/' + partes[0];
    }


    function Buscar() {

        var FechaInicio = $('#datepickerInicio').val();
        var FechaFin = $('#datepickerFin').val();

        var fechaInicioFormateada = formatFecha(FechaInicio);
        var fechaFinFormateada = formatFecha(FechaFin);

        var cb1 = document.getElementById('cb1').checked;
        var cb2 = document.getElementById('cb2').checked;

        if ((FechaInicio != "" && FechaFin != "") && (cb1 || cb2)) {

            //Requis Almacen
            if ($('#cb1').prop('checked')) {

                Swal.fire({
                    title: 'Realizando búsqueda',
                    timer: 1000,
                    timerProgressBar: true,
                    showConfirmButton: false,
                });

                var TipoReq = "RAC";

                $.ajax({
                    url: '@Url.Action("ObtenerReporteReq", "Requisicion")',
                    method: 'POST',
                    dataType: 'json',
                    data: { FechaInicio: fechaInicioFormateada, FechaFin: fechaFinFormateada, TipoReq: TipoReq },
                    success: function (data) {
                        if (data == 0 || data == "0") {
                            Swal.fire({
                                icon: 'error',
                                title: 'No se encontraron registros con los filtros ingresados'
                            });
                        }
                        if (data.MENSAJE) {
                            Swal.fire({
                                icon: 'error',
                                title: '¡Error!',
                                text: data.MENSAJE.substring(7),
                            });
                        }

                        LlenaTabla(data);
                    },
                    error: function (ex) {
                        Swal.fire({
                            icon: 'error',
                            title: '¡Error!',
                        });
                    }
                });
            }

                //Requis Farmacia
            if ($('#cb2').prop('checked')) {

                Swal.fire({
                    title: 'Realizando búsqueda',
                    timer: 1000,
                    timerProgressBar: true,
                    showConfirmButton: false,
                });

                var TipoReq = "RFC";

                $.ajax({
                        url: '@Url.Action("ObtenerReporteReq", "Requisicion")',
                        method: 'POST',
                        dataType: 'json',
                        data: { FechaInicio: fechaInicioFormateada, FechaFin: fechaFinFormateada, TipoReq: TipoReq },
                        success: function (data) {
                            if (data == 0 || data == "0") {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'No se encontraron registros con los filtros ingresados'
                                });
                            }
                            if (data.MENSAJE) {
                                Swal.fire({
                                    icon: 'error',
                                    title: '¡Error!',
                                    text: data.MENSAJE.substring(7),
                                });
                            }

                            LlenaTabla(data);
                        },
                        error: function (ex) {
                            Swal.fire({
                                icon: 'error',
                                title: '¡Error!',
                            });
                        }
                    });
            }

        } else {
            Swal.fire({
                icon: 'error',
                title: '¡Error!',
                text: 'Debe ingresar los filtros'
            });
        }
    }

    function LlenaTabla(data) {

        var table = $('#TblReporteReq').DataTable();
        table.destroy();

        table = $('#TblReporteReq').DataTable({
            responsive: true,
            searching: false,
            info: true,
            deferRender: true,
            scroller: true,
            scrollColapse: true,
            paging: false,
            lengthChange: false,
            language: {
                "zeroRecords": "No se encontraron registros",
                "search": "",
                "info": "_TOTAL_ filas",
                "infoEmpty": "",
                "paginate": {
                    "first": "Primero",
                    "last": "Último",
                    "next": "Siguiente",
                    "previous": "Anterior",
                },
                "select": {
                    "rows": " %d filas seleccionadas"
                },
            },
            data: data,
            columns: [
                { 'data': 'Folio', className: "text-center" },
                { 'data': 'Fecha', className: "text-center" },
                {
                    "data": "EstatusOC", className: "text-center", render: function (data) {
                        if (data == null) {
                            return '<h8 style="color:black; ">' + "Pendiente" + '</h8>';
                        } else {
                            return '<h8 style="color:black; ">' + data + '</h8>';
                        }
                    }
                },
                { 'data': 'Contrato', className: "text-center" },
                { 'data': 'Usuario', className: "text-center" },
                { 'data': 'Tipo', className: "text-center" },
                { 'data': 'Cantidad', className: "text-center" },
                {
                    "data": "CantidadPend", className: "text-center", render: function (data, type, row) {
                        if (data == null) {
                            return '<h8 style="color:black; ">' + row.Cantidad + '</h8>';
                        } else {
                            return '<h8 style="color:black; ">' + data + '</h8>';
                        }
                    }
                },
                { 'data': 'Clave', className: "text-center" },
                { 'data': 'Descripcion', className: "text-center" }
            ],
            dom: 'Bfrtip',
            buttons: [
                { extend: 'excel', text: 'Excel' },
                { extend: 'pdf', text: 'PDF' }
            ]
        });
    }

    document.getElementById('cb1').addEventListener('change', function () {
        var cb2 = document.getElementById('cb2');
        if (this.checked) {
            cb2.disabled = true;
        } else {
            cb2.disabled = false;
        }
    });

    document.getElementById('cb2').addEventListener('change', function () {
        var cb1 = document.getElementById('cb1');
        if (this.checked) {
            cb1.disabled = true;
        } else {
            cb1.disabled = false;
        }
    });

    function Limpiar() {
        location.reload();
    }

</script>